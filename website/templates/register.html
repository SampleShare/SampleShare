{% extends 'base.html' %}
{% block content %}

<div class="col-md-6 offset-md-3">      

    <h1>Register</h1>
    <br/>
    <form method="POST" action="">
        {% csrf_token %}

        {% if form.errors %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                Your Form Has Errors
                {% for field in form %}
                    {% if field.errors %}
                        {{ field.errors }}
                    {% endif %}
                {% endfor %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        {{ form.username.label_tag }} {{ form.username }}
        {{ form.email.label_tag }} {{ form.email }}
        {{ form.date_of_birth.label_tag }} {{ form.date_of_birth }}

        <!-- Password field -->
        {{ form.password1.label_tag }} {{ form.password1 }}

        <!-- Password Requirements Feedback (Positioned directly under the password field) -->
        <div id="password-requirements" style="display: none; margin-top: 5px;">
            <p id="length-req" style="color: red;">Your password must contain at least 8 characters.</p>
            <p id="common-req" style="color: red;">Your password can't be a commonly used password.</p>
            <p id="numeric-req" style="color: red;">Your password can't be entirely numeric.</p>
        </div>

        <!-- Confirm Password field -->
        {{ form.password2.label_tag }} {{ form.password2 }}

        <br/>
        <button type="submit" class="btn btn-secondary">Submit</button>

        <!-- JavaScript for Real-Time Password Validation (within the form) -->
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // Select the password input field and requirements container
                const passwordField = document.querySelector('#id_password1');
                const requirements = document.querySelector('#password-requirements');
                const lengthReq = document.querySelector('#length-req');
                const commonReq = document.querySelector('#common-req');
                const numericReq = document.querySelector('#numeric-req');

                let commonPasswords = [];

                // Function to load common passwords from a text file
                async function loadCommonPasswords() {
                    try {
                        // Fetch the common passwords file from the static directory
                        const response = await fetch('/static/image/common-passwords.txt');
                        const text = await response.text();
                        // Split the file content into an array (assuming one password per line)
                        commonPasswords = text.split('\n').map(pw => pw.trim().toLowerCase());
                    } catch (error) {
                        console.error("Error fetching common passwords:", error);
                        return [];
                    }
                }

                // Call function to load common passwords
                loadCommonPasswords();

                // Add event listener to password field
                passwordField.addEventListener('input', function() {
                    const password = passwordField.value;
                    requirements.style.display = 'block';
                    
                    // Length Requirement
                    if (password.length >= 8) {
                        lengthReq.style.color = 'green';
                    } else {
                        lengthReq.style.color = 'red';
                    }

                    // Common Password Check (using loaded common passwords from file)
                    if (commonPasswords.length > 0 && !commonPasswords.includes(password.toLowerCase())) {
                        commonReq.style.color = 'green';
                    } else {
                        commonReq.style.color = 'red';
                    }

                    // Numeric Check
                    if (!/^\d+$/.test(password)) {
                        numericReq.style.color = 'green';
                    } else {
                        numericReq.style.color = 'red';
                    }
                });
            });
        </script>
    </form>

</div>

{% endblock %}
